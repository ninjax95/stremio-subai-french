# Session - 10 fÃ©vrier 2026

## Contexte

**Projet :** Addon Stremio pour sous-titres franÃ§ais automatiques
**RÃ©pertoire :** `/home/ninjax/claude/IdÃ©es applications/Sous-titre stremio/`

### Description
Addon Stremio qui fournit des sous-titres franÃ§ais pour films et sÃ©ries. Quand aucun sous-titre franÃ§ais n'est disponible, il traduit automatiquement les sous-titres anglais via Ollama (IA locale avec modÃ¨le Mixtral).

### Architecture actuelle
- **Fichier principal :** `server.js` - Serveur Node.js utilisant Stremio addon SDK
- **Port :** 7000
- **DÃ©pendances :** Express, Stremio addon SDK, Node-fetch
- **Cache :** `subtitles_cache/` pour les traductions
- **Auto-dÃ©marrage :** `start-stremio.sh` lancÃ© au dÃ©marrage de Stremio

### Flux de fonctionnement
1. Stremio envoie requÃªte avec IMDB ID
2. Recherche sous-titres franÃ§ais sur OpenSubtitles
3. Si trouvÃ©s â†’ retour direct
4. Sinon â†’ recherche anglais â†’ traduction Mixtral â†’ cache â†’ retour

## Ã‰tat actuel

### Derniers commits
- `3fdf32a` - AmÃ©lioration interface monitor et gestion des sous-titres
- `88f66a9` - Add cache management interface and improvements
- `d1da567` - Auto-open monitor when launching Stremio
- `239e700` - Add real-time monitoring interface with progress bar
- `954ed20` - Add CLAUDE.md with project documentation

### Serveur
- **Statut :** ArrÃªtÃ© (dernier run: 10 fÃ©vrier 23:27)
- **Dernier log :** Traduction rÃ©ussie pour sÃ©rie tt2805096:13:11
- **PID file :** `server.pid` (processus terminÃ©)

### FonctionnalitÃ©s rÃ©centes
- Interface de monitoring en temps rÃ©el avec barre de progression
- Auto-ouverture du monitor au lancement de Stremio
- Cache des traductions pour rÃ©utilisation instantanÃ©e

## Configuration

### Variables d'environnement (server.js:14-34)
- `PORT` : 7000
- `OLLAMA_URL` : localhost:11434
- `OLLAMA_MODEL` : mixtral
- `OPENSUBTITLES_API_KEY` : Optionnel

### URLs
- **Manifest :** http://127.0.0.1:7000/manifest.json
- **Monitor :** http://127.0.0.1:7000/monitor

## DÃ©cisions importantes

### Isolation du projet
- Le fichier `CLAUDE.md` contient des rÃ¨gles strictes d'isolation
- Aucun accÃ¨s aux rÃ©pertoires parents ou frÃ¨res sans confirmation explicite
- Session locale isolÃ©e dans `.SESSION.md` du rÃ©pertoire

### Architecture technique
- Serveur monolithique en un seul fichier (server.js)
- Utilisation de Mixtral via Ollama pour traduction locale
- Cache SRT pour performances

## Changements rÃ©cents (10 fÃ©vrier 2026 23:35)

### Interface de gestion du cache
Ajout d'une interface web pour gÃ©rer les sous-titres en cache dans le monitor :

**Nouvelles fonctionnalitÃ©s :**
- ğŸ“‹ **Liste des sous-titres en cache** dans l'interface monitor
- ğŸ—‘ï¸ **Bouton de suppression** pour chaque sous-titre
- ğŸ“Š **Informations dÃ©taillÃ©es** : IMDB ID, taille, date de modification
- ğŸ”„ **Actualisation automatique** toutes les 10 secondes

**Nouvelles routes API :**
- `GET /api/cache` - Liste tous les sous-titres en cache avec mÃ©tadonnÃ©es
- `DELETE /api/cache/:filename` - Supprime un sous-titre spÃ©cifique

**Fichiers modifiÃ©s :**
- `server.js:824-877` - Ajout des routes API de gestion du cache
- `server.js:680-757` - Ajout des styles CSS pour l'interface cache
- `server.js:801-809` - Ajout de la section HTML cache
- `server.js:886-948` - Ajout du JavaScript pour gÃ©rer le cache

**Utilisation :**
1. Ouvrir http://127.0.0.1:7000/monitor
2. La section "ğŸ’¾ Sous-titres en cache" affiche tous les fichiers
3. Cliquer sur "ğŸ—‘ï¸ Supprimer" pour retirer un sous-titre dÃ©fectueux
4. Au prochain visionnage, le sous-titre sera retÃ©lÃ©chargÃ© et retraduit

**Impact :**
- Le cache reste actif pour de meilleures performances
- PossibilitÃ© de supprimer manuellement un sous-titre incorrect
- ContrÃ´le total sur le contenu du cache

## DerniÃ¨re amÃ©lioration (11 fÃ©vrier 2026 00:10)

### Annulation automatique des traductions
Ajout d'un systÃ¨me pour annuler les traductions en cours quand l'utilisateur change de mÃ©dia :

**Fonctionnement :**
- Quand une nouvelle requÃªte arrive pour un mÃ©dia diffÃ©rent, la traduction en cours est annulÃ©e
- Le fichier partiel est supprimÃ© pour Ã©viter les sous-titres incomplets
- Log de l'annulation dans le monitor
- Optimise les ressources en ne traduisant que ce qui est regardÃ©

**Modifications :**
- `server.js:62-66` - Ajout variable `currentTranslation` pour suivre les traductions
- `server.js:447-460` - DÃ©tection changement de mÃ©dia et annulation
- `server.js:383-394` - VÃ©rification du flag d'annulation entre chaque lot
- Suppression du fichier cache partiel si annulation

**Impact :**
- Les traductions inutiles sont arrÃªtÃ©es automatiquement
- Ã‰conomie de ressources (CPU, Ollama)
- Meilleure rÃ©activitÃ© quand on zappe entre Ã©pisodes

## AmÃ©lioration prÃ©cÃ©dente (10 fÃ©vrier 2026 23:45)

### Ouverture automatique du monitor
Le script ouvre maintenant le monitor Ã  chaque lancement, mÃªme si le serveur est dÃ©jÃ  actif :

**Modification :**
- ğŸŒ Le monitor s'ouvre dans le navigateur Ã  chaque lancement de Stremio
- â±ï¸ DÃ©lai de 1 seconde pour laisser le systÃ¨me se prÃ©parer
- ğŸ“¢ Message "ğŸŒ Ouverture du monitor..." pour informer l'utilisateur

**Fichier modifiÃ© :**
- `start-stremio.sh:18-24` - Ajout de l'ouverture du monitor quand serveur dÃ©jÃ  actif

## AmÃ©lioration prÃ©cÃ©dente (10 fÃ©vrier 2026 23:42)

### Script de dÃ©marrage amÃ©liorÃ©
Le script `start-stremio.sh` a Ã©tÃ© amÃ©liorÃ© pour plus de clartÃ© :

**AmÃ©liorations :**
- ğŸ¨ **Interface visuelle** avec header ASCII art
- âœ“ **Messages clairs** : "Serveur dÃ©jÃ  actif" ou "Serveur dÃ©marrÃ©"
- ğŸ“Š **Affichage du lien monitor** dans tous les cas
- ğŸ”” **Notifications desktop** pour informer l'utilisateur
- âš™ï¸ **Meilleure gestion d'erreurs** avec affichage des logs
- â±ï¸ **Timeout intelligent** (5 secondes max pour dÃ©marrage)

**Sortie du script :**
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ğŸ¬ Stremio + SubAI FranÃ§ais          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ Serveur SubAI dÃ©jÃ  actif sur le port 7000
  ğŸ“Š Monitor: http://127.0.0.1:7000/monitor

ğŸš€ Lancement de Stremio...
```

**Fichier modifiÃ© :**
- `start-stremio.sh` - Refonte complÃ¨te de l'interface utilisateur

## Prochaines Ã©tapes

âœ… Interface de gestion du cache opÃ©rationnelle
âœ… Script de dÃ©marrage amÃ©liorÃ© et testÃ©
âœ… Serveur fonctionnel

Le projet est maintenant complet et prÃªt Ã  l'emploi.

## Notes

### Commandes utiles
```bash
# DÃ©marrer le serveur
npm start

# Avec modÃ¨le personnalisÃ©
OLLAMA_MODEL=llama3 npm start

# Ajouter l'addon Ã  Stremio
# Ouvrir: http://127.0.0.1:7000/manifest.json
```

### ProblÃ¨mes connus
- OS-Legacy API retourne parfois des erreurs "getaddrinfo ENOTFOUND _"
- Le serveur OpenSubtitles v3 fonctionne correctement en fallback

### Cache
Les traductions sont sauvegardÃ©es dans `subtitles_cache/` avec des noms basÃ©s sur mediaId complet (ex: `tt2805096:13:11_fr.srt`) pour caching par Ã©pisode.

## AmÃ©liorations finales (11 fÃ©vrier 2026 01:10)

### IntÃ©gration OMDb et simplification de l'addon

**Commit :** `3fdf32a` - AmÃ©lioration interface monitor et gestion des sous-titres

**Changements majeurs :**

1. **API OMDb pour les titres**
   - Ajout de la clÃ© API OMDb : `e6235f29`
   - RÃ©cupÃ©ration automatique des titres de films/sÃ©ries
   - Cache des titres pendant 7 jours
   - Affichage dans le monitor : "Chicago P.D. - S13E11" au lieu de "tt2805096:13:11"

2. **Simplification de l'identification addon**
   - Changement du nom de l'addon : "SubAI" (au lieu de "SubAI FranÃ§ais")
   - ID du sous-titre simplifiÃ© : `id: 'SubAI'`
   - Utilisation de `lang: 'fra'` au lieu de `lang: 'fre'`
   - Suppression du champ `title` dans l'objet sous-titre

3. **Cache par Ã©pisode**
   - Les fichiers cache utilisent maintenant le mediaId complet
   - Format : `tt2805096:13:11_fr.srt` au lieu de `tt2805096_fr.srt`
   - Permet d'avoir un cache distinct pour chaque Ã©pisode d'une sÃ©rie

**Modifications du code :**
- `server.js:25-26` - Ajout CONFIG.OMDB_API_KEY
- `server.js:44-45` - Ajout titlesCache avec TTL de 7 jours
- `server.js:102` - Changement nom addon : "SubAI"
- `server.js:269-301` - Fonction getMediaTitle() pour OMDb
- `server.js:525-528` - Format de retour simplifiÃ© des sous-titres

**Tests effectuÃ©s :**
- Serveur testÃ© avec plusieurs Ã©pisodes de Chicago P.D. (S13E6, S13E8, S13E11, S13E12)
- SystÃ¨me d'annulation fonctionnel lors du changement d'Ã©pisode
- API OMDb fonctionnelle pour rÃ©cupÃ©ration des titres
- Cache correctement gÃ©rÃ© par Ã©pisode

**ProblÃ¨me observÃ© :**
- Dans les logs `/tmp/server-name.log`, le processus a Ã©tÃ© tuÃ© (`Killed`) pendant une traduction
- Ligne 103 : arrÃªt brutal pendant "Traduction lot 19/30 (60%)"
- Cause probable : consommation mÃ©moire excessive ou limite systÃ¨me
- Ã€ surveiller lors de l'utilisation intensive

**Ã‰tat actuel :**
- âœ… Tous les changements committÃ©s
- âœ… OMDb API intÃ©grÃ©e et fonctionnelle
- âœ… Addon clairement identifiable dans Stremio comme "SubAI"
- âœ… Cache par Ã©pisode opÃ©rationnel
- âš ï¸ Surveiller la consommation mÃ©moire lors des traductions longues
